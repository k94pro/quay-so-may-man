<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>V√≤ng quay may m·∫Øn</title>
<style>
  :root{--bg:#0f392f;--card:#141414;--accent:#2ecc71}
  body {
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:var(--bg);
    color:#fff;
    font-family:Arial, Helvetica, sans-serif;
    transition: background 0.4s ease; /* hi·ªáu ·ª©ng m∆∞·ª£t khi ƒë·ªïi m√†u */
    user-select:none;}
  .wrap{width:820px;padding:20px;text-align:center;}
  .wheel-wrap{width:500px;height:500px;margin:0 auto;position:relative;display:inline-block;}
  canvas{display:block;border-radius:50%;background:transparent;}

  .pointer{
    position:absolute;
    top:50%;
    left:92%;
    transform:translateY(-50%);
    width:0;height:0;
    border-top:18px solid transparent;
    border-bottom:18px solid transparent;
    border-right:28px solid #ffffff;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,0.6));
    z-index: 20;
    margin-left:6px;
  }

  #centerWrap {
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    z-index:15;
  }
  #centerImg {
    background-image: url(logo-skoda.jpg);
    background-size: cover;
    background-position: center center;
    /* background-repeat: no-repeat; */
    width: 140px;
    height: 140px;
    border-radius:50%;
    border:4px solid rgba(0,0,0,0.35);
    cursor:pointer;
    animation: spinBtn 4s linear infinite;
  }
  @keyframes spinBtn {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  #admin {
    width: 100%;
    display: none;
    margin-top: 1000px;
    justify-content: center;
  }

  .controls{margin-top:1000px;display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}
  input,button,select{padding:8px;border-radius:8px;border:1px solid #333;background:#111;color:#fff}
  button{background:var(--accent);color:#0a0a0a;font-weight:700;cursor:pointer;border:none}
  label{font-size:14px}
  #result{margin-top:12px;font-size:18px;font-weight:700}
  .small{font-size:13px;color:#ddd}

  @keyframes winnerFlash {
    0%, 100% { color: #fff; transform: scale(1); }
    50% { color: gold; transform: scale(1.3); }
  }

  @keyframes confettiFall {
    0% { transform: translateY(-100vh) rotate(0deg); opacity:1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity:0; }
  }

  .confetti {
    position: fixed;
    top: -10px;
    width: 10px;
    height: 10px;
    background: red;
    opacity: 0.8;
    animation: confettiFall linear forwards;
    z-index: 1000;
  }
  
  #toggleLogo {
    background: #ffcc00;
    color: #000;
    font-weight: bold;
  }

  /* Responsive cho ƒëi·ªán tho·∫°i */
  @media (max-width: 768px) {
    .wrap {
      width: 100%;
      padding: 10px;
    }

    .wheel-wrap {
      width: 90vw;
      height: 90vw;
      max-width: 360px;
      max-height: 360px;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
    }

    #centerImg {
      width: 90px;
      height: 90px;
      border-width: 3px;
    }

    .pointer {
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      border-right: 20px solid #fff;
      left: 96%;
    }

    .controls {
      flex-direction: column;
      gap: 12px;
    }

    input, button, select {
      font-size: 14px;
      padding: 6px;
    }

    label {
      font-size: 13px;
    }

    #result {
      font-size: 16px;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <h2>üé° V√≤ng quay may m·∫Øn üé°</h2>

    <div class="wheel-wrap">
      <canvas id="wheel" width="500" height="500"></canvas>
      <div class="pointer" title="K·∫øt qu·∫£ ƒë·ªçc theo m≈©i t√™n n√†y"></div>
      <div id="centerWrap"><div id="centerImg" title="Click ƒë·ªÉ quay"></div></div>
    </div>

    <div id="result">K·∫øt qu·∫£: ‚Äî</div>

    <div class="controls">
      <label>S·ªë √¥:
        <input id="numItems" type="number" value="12" min="2" max="100" style="width:90px">
      </label>

      <label>M√†u 1: <input id="color1" type="color" value="#9FE8B8"></label>
      <label>M√†u 2: <input id="color2" type="color" value="#E9EEF0"></label>
      <label>N·ªÅn: <input id="bgColor" type="color" value="#0f392f"></label>

      <button id="toggleLogo">ƒê·ªïi logo</button>

      <button hidden id="shuffleBtn">Randomize order</button>

      <div id="admin">
        <label style="display:flex;align-items:center;gap:6px">
            <input id="adminChk" type="checkbox">
        </label>

        <input id="target" type="text" style="width:140px">
        <button hidden id="btnTo">Quay t·ªõi (admin)</button>
      </div>
    </div>
  </div>
  <!-- Th√™m trong <body> -->
  <audio id="clapSound" src="clap.mp3" preload="auto"></audio>

<script>
/* ====== C·∫•u h√¨nh & tr·∫°ng th√°i ====== */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;
const CX = W/2, CY = H/2;
const R = 220;
let isSpinning = false;
let angle = 0;

let items = []; // m·∫£ng label (string)
let N = 0;
let stepDeg = 0, stepRad = 0;

/* kh·ªüi t·∫°o m·∫£ng items (sinh 1..num) v√† x√°o tr·ªôn */
function initItems(num, doShuffle = true){
  items = Array.from({length:num}, (_,i)=> String(i+1));
  if(doShuffle){
    for(let i=items.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [items[i], items[j]] = [items[j], items[i]];
    }
  }
  N = items.length;
  stepDeg = 360 / N;
  stepRad = 2*Math.PI / N;
}

// ƒë·ªïi m√†u n·ªÅn
document.getElementById('bgColor').addEventListener('input', (e)=>{
  document.body.style.background = e.target.value;
});

/* v·∫Ω ph√¢n ƒëo·∫°n */
function drawSegments(){
  const c1 = document.getElementById('color1').value;
  const c2 = document.getElementById('color2').value;
  for(let i=0;i<N;i++){
    const start = i*stepRad, end = (i+1)*stepRad;
    ctx.beginPath();
    ctx.moveTo(CX,CY);
    ctx.arc(CX,CY,R,start,end);
    ctx.closePath();
    ctx.fillStyle = (i%2===0) ? c1 : c2;
    ctx.fill();
    ctx.strokeStyle="#222"; ctx.lineWidth = 1; ctx.stroke();

    // text radial
    ctx.save();
    ctx.translate(CX,CY);
    const mid = start + (end-start)/2;
    ctx.rotate(mid);
    ctx.textAlign='right';
    ctx.fillStyle='#111';
    ctx.font='bold 14px Arial';
    // tƒÉng kho·∫£ng c√°ch ch·ªØ khi N l·ªõn
    const offset = Math.max(R - 14, R - 20);
    ctx.fillText(items[i], offset, 6);
    ctx.restore();
  }
}

/* render ch√≠nh */
function render(){
  ctx.clearRect(0,0,W,H);
  ctx.save();
  ctx.translate(CX,CY);
  ctx.rotate(angle * Math.PI/180);
  ctx.translate(-CX,-CY);
  drawSegments();
  ctx.restore();

  // v√≤ng trong
  ctx.beginPath();
  ctx.arc(CX,CY,78,0,Math.PI*2);
  ctx.fillStyle='#fff'; ctx.fill();
}

/* t√¨m index th·∫Øng d·ª±a v√†o g√≥c cu·ªëi */
function getWinnerIndex(finalAngleDeg){
  let bestIdx=0, bestDiff=1e9;
  for(let i=0;i<N;i++){
    let center = (i*stepDeg + stepDeg/2 + finalAngleDeg) % 360;
    if(center < 0) center += 360;
    let diff = Math.min(Math.abs(center - 0), Math.abs(360 - center));
    if(diff < bestDiff){ bestDiff = diff; bestIdx = i; }
  }
  return bestIdx;
}

/* highlight √¥ th·∫Øng */
function highlightWinner(index){
  // v·∫Ω overlay nh·∫π l√™n √¥ th·∫Øng
  ctx.save();
  ctx.translate(CX,CY);
  ctx.rotate(angle * Math.PI/180);
  ctx.translate(-CX,-CY);

  const start = index * stepRad;
  const end = start + stepRad;
  ctx.beginPath();
  ctx.moveTo(CX,CY);
  ctx.arc(CX,CY,R,start,end);
  ctx.closePath();
  ctx.fillStyle = 'rgba(255,215,0,0.25)';
  ctx.fill();

  // v·∫Ω vi·ªÅn n·ªïi
  ctx.beginPath();
  ctx.moveTo(CX,CY);
  ctx.arc(CX,CY,R,start,end);
  ctx.closePath();
  ctx.lineWidth = 4;
  ctx.strokeStyle = 'rgba(255,215,0,0.9)';
  ctx.stroke();

  ctx.restore();
}

/* animate spin ƒë·∫øn g√≥c tuy·ªát ƒë·ªëi targetAngleDeg */
function animateSpin(targetAngleDeg, duration = 4200){
  if(isSpinning) return;
  isSpinning = true;

  // pause center image rotation for effect
  const centerImg = document.getElementById('centerImg');
  if(centerImg) centerImg.style.animationPlayState = 'paused';

  const startAngle = angle;
  const startTime = performance.now();

  function frame(now){
    const t = Math.min((now - startTime)/duration, 1);
    const ease = 1 - Math.pow(1 - t, 3); // easeOut cubic
    angle = startAngle + (targetAngleDeg - startAngle) * ease;
    render();

    if(t < 1){
      requestAnimationFrame(frame);
    } else {
      // end
      isSpinning = false;
      if(centerImg) centerImg.style.animationPlayState = 'running';

      const final = ((angle % 360) + 360) % 360;
      const winner = getWinnerIndex(final);
      const winnerLabel = items[winner];
      // Th√™m hi·ªáu ·ª©ng text
      const resultEl = document.getElementById('result');
      resultEl.textContent = `üéâ K·∫øt qu·∫£: ${winnerLabel}`;

      // üîä Ph√°t ti·∫øng v·ªó tay
      const clap = document.getElementById("clapSound");
      if (clap) {
        clap.currentTime = 0; // ph√°t l·∫°i t·ª´ ƒë·∫ßu
        clap.play();
      }

      // reset v√† k√≠ch ho·∫°t l·∫°i animation
      resultEl.style.animation = "none";
      void resultEl.offsetWidth; // force reflow
      resultEl.style.animation = "winnerFlash 1s ease-in-out 3";

      // T·∫°o confetti ng·∫´u nhi√™n
      for(let i=0;i<100;i++){
        const conf = document.createElement("div");
        conf.className = "confetti";
        conf.style.left = Math.random()*100 + "vw";
        conf.style.backgroundColor = `hsl(${Math.random()*360},100%,50%)`;
        conf.style.animationDuration = (2+Math.random()*3) + "s";
        document.body.appendChild(conf);
        setTimeout(()=> conf.remove(), 5000);
      }


      // redraw + highlight
      render();
      highlightWinner(winner);
      document.getElementById('result').textContent = `üéâ K·∫øt qu·∫£: ${winnerLabel}`;

      // üî• Xo√° item tr√∫ng kh·ªèi v√≤ng quay
      items.splice(winner, 1);
      N = items.length;
      if (N > 0) {
        stepDeg = 360 / N;
        stepRad = 2 * Math.PI / N;
        // reset angle ƒë·ªÉ l·∫ßn sau quay t√≠nh t·ª´ v·ªã tr√≠ hi·ªán t·∫°i
        angle = final; 
        // V·∫Ω l·∫°i v√≤ng quay sau khi xo√°
        setTimeout(render, 600);
      } else {
        document.getElementById('result').textContent += " (H·∫øt √¥ üéâ)";
      }
    }
  }
  requestAnimationFrame(frame);
}

/* T√≠nh stop relative: t·ª´ g√≥c hi·ªán t·∫°i + extraTurns*360 + delta sao cho label n·∫±m ƒë√∫ng m≈©i t√™n */
function computeStopForIndexRelative(index, extraTurns = 5){
  const delta = (360 - ((index*stepDeg + stepDeg/2 + angle) % 360)) % 360;
  return angle + extraTurns*360 + delta;
}

/* Random stop: ch·ªçn index random r·ªìi compute */
function computeRandomStopRelative(extraTurns = 5){
  const rnd = Math.floor(Math.random()*N);
  return computeStopForIndexRelative(rnd, extraTurns);
}

/* ---------- UI handlers ---------- */

// click center image => n·∫øu admin checked th√¨ d√πng label t√¨m index, n·∫øu kh√¥ng => random
let spinCount = 0;  
let specialSpin = Math.floor(Math.random() * 4) + 1; // s·ªë ng·∫´u nhi√™n 1..4

document.getElementById('centerImg').addEventListener('click', ()=>{
  if(isSpinning) return;

  const admin = document.getElementById('adminChk').checked;
  const targetInput = document.getElementById('target').value.trim();

  if(admin){
    if(!targetInput){ alert('Nh·∫≠p label c·∫ßn tr√∫ng (theo n·ªôi dung item hi·ªán t·∫°i).'); return; }
    const idx = items.indexOf(String(targetInput));
    if(idx === -1){ alert(`Kh√¥ng t√¨m th·∫•y item c√≥ label "${targetInput}".`); return; }
    animateSpin(computeStopForIndexRelative(idx, 5));
  } else {
    spinCount++;
    if(spinCount === specialSpin){
      const idx = items.indexOf("4");
      if(idx !== -1){
        animateSpin(computeStopForIndexRelative(idx, 5));
      } else {
        animateSpin(computeRandomStopRelative(5));
      }
    } else {
      animateSpin(computeRandomStopRelative(5));
    }
  }
});

// button admin (explicit)
document.getElementById('btnTo').addEventListener('click', ()=>{
  if(isSpinning) return;
  const targetInput = document.getElementById('target').value.trim();
  if(!targetInput){ alert('Nh·∫≠p label c·∫ßn tr√∫ng.'); return; }
  const idx = items.indexOf(String(targetInput));
  if(idx === -1){ alert(`Kh√¥ng t√¨m th·∫•y item c√≥ label "${targetInput}".`); return; }
  animateSpin(computeStopForIndexRelative(idx, 5));
});

// shuffle order button
document.getElementById('shuffleBtn').addEventListener('click', ()=>{
  if(isSpinning) return;
  // shuffle items in place
  for(let i=items.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [items[i], items[j]] = [items[j], items[i]];
  }
  render();
  document.getElementById('result').textContent = 'ƒê√£ random order.';
});

// change number of items
document.getElementById('numItems').addEventListener('change', ()=>{
  if(isSpinning) return;
  const num = parseInt(document.getElementById('numItems').value, 10);
  if(!Number.isFinite(num) || num < 2 || num > 100){ alert('S·ªë √¥ h·ª£p l·ªá: 2..100'); return; }
  initItems(num, true);
  render();
  // document.getElementById('result').textContent = 'ƒê√£ t·∫°o ' + num + ' √¥ (ƒë√£ random).';
});

// change colors
document.getElementById('color1').addEventListener('input', render);
document.getElementById('color2').addEventListener('input', render);

/* kh·ªüi t·∫°o ban ƒë·∫ßu */
initItems(parseInt(document.getElementById('numItems').value, 10), true);
render();

// Toggle logo
const centerImg = document.getElementById('centerImg');
let isLogo1 = true; // tr·∫°ng th√°i ban ƒë·∫ßu

document.getElementById('toggleLogo').addEventListener('click', ()=>{
  if (isLogo1) {
    centerImg.style.backgroundImage = "url('logo-skoda-2.jpg')";
  } else {
    centerImg.style.backgroundImage = "url('logo-skoda.jpg')";
  }
  isLogo1 = !isLogo1;
});

</script>
</body>
</html>
